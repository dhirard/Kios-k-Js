<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Checkout - JS Florist</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600;700&family=Poppins:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="dist/tailwind.generated.css" />
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div class="container">
      <header>
        <h1>üå∏ JS Florist</h1>
        <nav>
          <a href="index.html" class="nav-link">Katalog</a>
          <span class="nav-link active">Checkout</span>
          <a href="admin-login.html" class="nav-link admin-link"> üîê Admin </a>
        </nav>
      </header>

      <main>
        <section class="checkout-section">
          <h2>Konfirmasi Pesanan</h2>

          <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>Memuat pesanan...</p>
          </div>

          <div id="checkout-content" style="display: none">
            <div class="checkout-container">
              <div class="order-summary">
                <h3>Ringkasan Pesanan</h3>
                <div class="order-items" id="order-items">
                  <!-- Order items will be loaded here -->
                </div>

                <div class="order-total">
                  <div class="total-row">
                    <span>Total Item:</span>
                    <span id="total-items">0</span>
                  </div>
                  <div class="total-row grand-total">
                    <span>Total Pembayaran:</span>
                    <span id="total-amount">Rp 0</span>
                  </div>
                </div>
              </div>

              <div class="payment-section">
                <h3>Detail Pengantaran</h3>
                <div class="order-form">
                  <div class="form-group">
                    <label for="buyer-name">Nama Pembeli</label>
                    <input
                      type="text"
                      id="buyer-name"
                      placeholder="Nama pembeli"
                      required
                    />
                  </div>
                  <div class="form-group">
                    <label for="recipient-name">Nama Penerima</label>
                    <input
                      type="text"
                      id="recipient-name"
                      placeholder="Nama penerima (opsional)"
                    />
                  </div>
                  <div class="form-group">
                    <label for="phone">Nomor Telepon</label>
                    <input
                      type="tel"
                      id="phone"
                      placeholder="08xxxxxxxxxx"
                      required
                    />
                  </div>
                  <div class="form-group">
                    <label>Tipe Pengantaran</label>
                    <label class="payment-option" style="border-color: #e0e0e0">
                      <input
                        type="radio"
                        name="delivery-type"
                        value="delivery"
                        checked
                      />
                      <span class="payment-label">üöö Antar ke alamat</span>
                    </label>
                    <label class="payment-option" style="border-color: #e0e0e0">
                      <input type="radio" name="delivery-type" value="pickup" />
                      <span class="payment-label">üè¨ Ambil di tempat</span>
                    </label>
                  </div>
                  <div class="form-group" id="address-group">
                    <label for="delivery-address">Alamat Lengkap</label>
                    <textarea
                      id="delivery-address"
                      placeholder="Alamat lengkap untuk pengantaran"
                      style="min-height: 70px"
                    ></textarea>
                  </div>
                  <div class="form-group" id="datetime-group">
                    <label for="delivery-datetime"
                      >Tanggal & Jam Pengantaran</label
                    >
                    <input type="datetime-local" id="delivery-datetime" />
                  </div>
                  <div class="form-group">
                    <label for="order-notes">Catatan</label>
                    <textarea
                      id="order-notes"
                      placeholder="Catatan untuk pesanan (opsional)"
                      style="min-height: 70px"
                    ></textarea>
                  </div>
                </div>

                <h3>Metode Pembayaran</h3>
                <div class="payment-methods">
                  <label class="payment-option">
                    <input type="radio" name="payment" value="qris" />
                    <span class="payment-label">üì± QRIS</span>
                  </label>
                  <label class="payment-option">
                    <input type="radio" name="payment" value="transfer" />
                    <span class="payment-label">üè¶ Transfer</span>
                  </label>
                  <label class="payment-option">
                    <input type="radio" name="payment" value="cash" checked />
                    <span class="payment-label">üíµ Tunai (Cash)</span>
                  </label>
                </div>

                <div class="checkout-actions">
                  <button class="btn-secondary btn-large" onclick="goBack()">
                    ‚Üê Kembali ke Keranjang
                  </button>
                  <button
                    class="btn-primary btn-large"
                    id="confirm-payment-btn"
                  >
                    Konfirmasi Pembayaran
                  </button>
                </div>
              </div>
            </div>
          </div>

          <div class="empty-checkout" id="empty-checkout" style="display: none">
            <div class="empty-icon">üõí</div>
            <h3>Tidak Ada Pesanan</h3>
            <p>Keranjang Anda kosong. Silakan tambah produk terlebih dahulu.</p>
            <a href="index.html" class="btn-primary">Mulai Belanja</a>
          </div>
        </section>
      </main>

      <footer>
        <p>&copy; 2025 JS Florist. Bunga segar setiap hari.</p>
      </footer>
    </div>

    <!-- Example trigger for silent receipt printing -->
    <div style="position: fixed; bottom: 10px; right: 10px; z-index: 1000">
      <button id="btnPrintReceipt" class="btn-secondary">
        Cetak Struk Penjualan
      </button>
    </div>

    <!-- Success modal -->
    <div id="success-modal" class="modal">
      <div class="modal-content success-content">
        <div class="success-icon">‚úÖ</div>
        <h3>Pembayaran Berhasil!</h3>
        <p>Terima kasih atas pembelian Anda.</p>
        <div class="order-info">
          <p><strong>ID Pesanan:</strong> <span id="order-id"></span></p>
          <p>
            <strong>Total Pembayaran:</strong> <span id="final-amount"></span>
          </p>
          <p><strong>Waktu:</strong> <span id="order-time"></span></p>
          <p><strong>Pembeli:</strong> <span id="info-buyer"></span></p>
          <p><strong>Penerima:</strong> <span id="info-recipient"></span></p>
          <p><strong>Telepon:</strong> <span id="info-phone"></span></p>
          <p><strong>Tipe:</strong> <span id="info-delivery-type"></span></p>
          <p>
            <strong>Waktu Antar:</strong> <span id="info-delivery-dt"></span>
          </p>
          <p><strong>Alamat:</strong> <span id="info-address"></span></p>
          <p>
            <strong>Metode Pembayaran:</strong> <span id="info-payment"></span>
          </p>
          <p><strong>Catatan:</strong> <span id="info-notes"></span></p>
        </div>
        <div class="modal-actions">
          <button id="manual-print-btn" class="btn btn-secondary">
            üñ®Ô∏è Print Manual
          </button>
          <button id="new-order-btn" class="btn-primary">Pesanan Baru</button>
        </div>
      </div>
    </div>

    <!-- Loading modal -->
    <div id="processing-modal" class="modal">
      <div class="modal-content">
        <div class="spinner"></div>
        <h3>Memproses Pembayaran...</h3>
        <p>Mohon tunggu sebentar</p>
      </div>
    </div>

    <!-- Success notification -->
    <div id="notification" class="notification">
      <span id="notification-text"></span>
      <button id="notification-close">&times;</button>
    </div>

    <script src="renderer.js"></script>
    <script src="navigation.js"></script>
    <script>
      let cartItems = [];
      let componentsMap = new Map();
      let totalAmount = 0;

      // Initialize the checkout page
      document.addEventListener("DOMContentLoaded", async () => {
        try {
          const comps = await window.electronAPI.getComponents();
          if (Array.isArray(comps)) {
            componentsMap = new Map(comps.map((c) => [Number(c.id), c]));
          }
        } catch (_) {}
        await loadCheckoutData();
        setupEventListeners();
      });

      async function loadCheckoutData() {
        const loading = document.getElementById("loading");
        const checkoutContent = document.getElementById("checkout-content");
        const emptyCheckout = document.getElementById("empty-checkout");

        try {
          loading.style.display = "flex";
          cartItems = await window.electronAPI.getCartItems();

          if (cartItems.length === 0) {
            checkoutContent.style.display = "none";
            emptyCheckout.style.display = "block";
          } else {
            renderOrderSummary();
            checkoutContent.style.display = "block";
            emptyCheckout.style.display = "none";
          }
        } catch (error) {
          console.error("Error loading checkout data:", error);
          showNotification("Gagal memuat data pesanan", "error");
        } finally {
          loading.style.display = "none";
        }
      }

      function renderOrderSummary() {
        const orderItemsContainer = document.getElementById("order-items");

        orderItemsContainer.innerHTML = cartItems
          .map(
            (item) => `
                <div class="order-item">
                    <div class="item-image">
                        <img src="${
                          item.image ||
                          "https://via.placeholder.com/60x60/e0e0e0/666?text=No+Image"
                        }" 
                             alt="${item.name}"
                             onerror="this.src='https://via.placeholder.com/60x60/e0e0e0/666?text=No+Image'">
                    </div>
                    <div class="item-details">
                        <h4>${item.name}</h4>
                        ${
                          item.variant_name
                            ? `<div class="small-note">Varian: ${item.variant_name}</div>`
                            : ""
                        }
                        ${renderCustomDetails(item)}
                        <p>${window.electronAPI.formatCurrency(item.price)} √ó ${
              item.quantity
            }</p>
                    </div>
                    <div class="item-total">
                        ${window.electronAPI.formatCurrency(item.subtotal)}
                    </div>
                </div>
            `
          )
          .join("");

        // Calculate totals
        const totalItems = cartItems.reduce(
          (sum, item) => sum + item.quantity,
          0
        );
        totalAmount = cartItems.reduce((sum, item) => sum + item.subtotal, 0);

        document.getElementById("total-items").textContent = totalItems;
        document.getElementById("total-amount").textContent =
          window.electronAPI.formatCurrency(totalAmount);
      }

      function renderCustomDetails(item) {
        if (!item.custom) return "";
        const {
          mode,
          materials = [],
          flowers = [],
          items = [],
        } = item.custom || {};
        const parts = [];
        if (mode)
          parts.push(
            `<div class=\"small-note\">Custom: ${escapeHtml(mode)}</div>`
          );
        if (Array.isArray(items) && items.length) {
          const list = items
            .map((it) => `${escapeHtml(it.name)} x${Number(it.quantity) || 1}`)
            .join(", ");
          parts.push(`<div class=\"small-note\">‚Ä¢ Item: ${list}</div>`);
        }
        const mapName = (cid) =>
          escapeHtml(componentsMap.get(Number(cid))?.name || `#${cid}`);
        if (Array.isArray(materials) && materials.length) {
          const list = materials
            .map(
              (m) => `${mapName(m.component_id)} x${Number(m.quantity) || 1}`
            )
            .join(", ");
          parts.push(`<div class=\"small-note\">‚Ä¢ Material: ${list}</div>`);
        }
        if (Array.isArray(flowers) && flowers.length) {
          const list = flowers
            .map(
              (f) => `${mapName(f.component_id)} x${Number(f.quantity) || 1}`
            )
            .join(", ");
          parts.push(`<div class=\"small-note\">‚Ä¢ Bunga: ${list}</div>`);
        }
        return parts.join("");
      }

      // Build plain details array for printing
      function buildDetailsForPrint(item) {
        if (!item.custom) return [];
        const { materials = [], flowers = [], items = [] } = item.custom || {};
        const details = [];
        const mapName = (cid) =>
          componentsMap.get(Number(cid))?.name || `#${cid}`;
        if (Array.isArray(items) && items.length) {
          const list = items
            .map((it) => `${it.name} x${Number(it.quantity) || 1}`)
            .join(", ");
          details.push(`Item: ${list}`);
        }
        if (Array.isArray(materials) && materials.length) {
          const list = materials
            .map(
              (m) => `${mapName(m.component_id)} x${Number(m.quantity) || 1}`
            )
            .join(", ");
          details.push(`Material: ${list}`);
        }
        if (Array.isArray(flowers) && flowers.length) {
          const list = flowers
            .map(
              (f) => `${mapName(f.component_id)} x${Number(f.quantity) || 1}`
            )
            .join(", ");
          details.push(`Bunga: ${list}`);
        }
        return details;
      }

      function escapeHtml(str) {
        return String(str || "").replace(
          /[&"'<>]/g,
          (c) =>
            ({
              "&": "&amp;",
              "<": "&lt;",
              ">": "&gt;",
              '"': "&quot;",
              "'": "&#39;",
            }[c])
        );
      }

      function setupEventListeners() {
        // Confirm payment button
        document
          .getElementById("confirm-payment-btn")
          .addEventListener("click", async () => {
            await processPayment();
          });

        // New order button in success modal
        document
          .getElementById("new-order-btn")
          .addEventListener("click", () => {
            window.electronAPI.navigateTo("index.html");
          });

        // Close notification
        document
          .getElementById("notification-close")
          .addEventListener("click", () => {
            document.getElementById("notification").classList.remove("show");
          });
      }

      async function processPayment() {
        const processingModal = document.getElementById("processing-modal");
        const successModal = document.getElementById("success-modal");

        try {
          // Show processing modal
          processingModal.style.display = "flex";

          // Get selected payment method
          const selectedPayment =
            (document.querySelector('input[name="payment"]:checked') || {})
              .value || "cash";
          const buyerName = (
            document.getElementById("buyer-name")?.value || ""
          ).trim();
          const recipientName = (
            document.getElementById("recipient-name")?.value || ""
          ).trim();
          const phone = (document.getElementById("phone")?.value || "").trim();
          const deliveryType =
            (
              document.querySelector('input[name="delivery-type"]:checked') ||
              {}
            ).value || "delivery";
          const address = (
            document.getElementById("delivery-address")?.value || ""
          ).trim();
          const deliveryDt = (
            document.getElementById("delivery-datetime")?.value || ""
          ).trim();
          const notes = (
            document.getElementById("order-notes")?.value || ""
          ).trim();

          // Simple validation
          if (!buyerName) throw new Error("Nama pembeli wajib diisi");
          if (!phone) throw new Error("Nomor telepon wajib diisi");
          if (deliveryType === "delivery") {
            if (!address)
              throw new Error("Alamat wajib diisi untuk pengantaran");
            if (!deliveryDt)
              throw new Error("Tanggal & jam pengantaran wajib diisi");
          }

          // Simulate payment processing delay
          await new Promise((resolve) => setTimeout(resolve, 2000));

          // Process checkout
          const orderId = await window.electronAPI.checkout(totalAmount);

          if (orderId) {
            // Hide processing modal
            processingModal.style.display = "none";

            // Show success modal
            document.getElementById("order-id").textContent = `#${orderId
              .toString()
              .padStart(6, "0")}`;
            document.getElementById("final-amount").textContent =
              window.electronAPI.formatCurrency(totalAmount);
            const nowStr = new Date().toLocaleString("id-ID");
            document.getElementById("order-time").textContent = nowStr;
            document.getElementById("info-buyer").textContent = buyerName;
            document.getElementById("info-recipient").textContent =
              recipientName || "-";
            document.getElementById("info-phone").textContent = phone;
            document.getElementById("info-delivery-type").textContent =
              deliveryType === "delivery"
                ? "Antar ke alamat"
                : "Ambil di tempat";
            document.getElementById("info-delivery-dt").textContent = deliveryDt
              ? new Date(deliveryDt).toLocaleString("id-ID")
              : "-";
            document.getElementById("info-address").textContent =
              address || "-";
            document.getElementById("info-payment").textContent =
              selectedPayment.toUpperCase();
            document.getElementById("info-notes").textContent = notes || "-";

            successModal.style.display = "flex";

            // Try to auto-print receipt
            try {
              console.log("üñ®Ô∏è Attempting auto print...");
              const payload = {
                orderId,
                total: totalAmount,
                items: cartItems.map((it) => ({
                  name: it.variant_name
                    ? `${it.name} (${it.variant_name})`
                    : it.name,
                  quantity: it.quantity,
                  price: it.price,
                  // include details for custom items on receipt
                  details:
                    Array.isArray(it.custom) || it.custom
                      ? buildDetailsForPrint(it)
                      : [],
                })),
                buyer: {
                  name: buyerName,
                  phone,
                },
                recipient: {
                  name: recipientName,
                },
                delivery: {
                  type: deliveryType, // delivery | pickup
                  address,
                  datetime: deliveryDt,
                },
                customerNotes: notes,
                businessName: "JS Florist",
                address:
                  "Jl. Dahlia No.23, Komet, Kec. Banjarbaru Selatan, Kota Banjar Baru",
                website: "www.jsflorist.com",
                whatsapp: "+62 823-5741-8002",
                instagram: "jsflorist.banjarbaru",
                servedByFlorist: (function () {
                  try {
                    return (
                      Number(localStorage.getItem("activeFlorist")) || null
                    );
                  } catch (_) {
                    return null;
                  }
                })(),
                printMode: "escpos",
                paymentMethod: selectedPayment,
              };

              const printRes = await window.electronAPI.printReceiptAuto(
                payload
              );
              console.log("üñ®Ô∏è Print receipt result:", printRes);

              if (printRes.success) {
                console.log(
                  "‚úÖ Receipt printed successfully to:",
                  printRes.device || "default printer"
                );
                showNotification("Struk berhasil dicetak", "success");
              } else {
                console.warn(
                  "‚ö†Ô∏è Auto print failed:",
                  printRes.failureReason || printRes.message
                );
                // Try to show available printers for troubleshooting
                const printers = await window.electronAPI.getPrinters();
                console.log(
                  "üìã Available printers:",
                  printers.map((p) => p.name)
                );

                // Show notification but don't block the success flow
                showNotification(
                  "Checkout berhasil, namun gagal mencetak struk otomatis",
                  "warning"
                );
              }
            } catch (e) {
              console.warn("‚ùå Auto print error:", e);
              showNotification(
                "Checkout berhasil, struk dapat dicetak manual",
                "info"
              );
            }
          } else {
            throw new Error("Checkout failed");
          }
        } catch (error) {
          console.error("Error processing payment:", error);
          processingModal.style.display = "none";
          showNotification(
            "Gagal memproses pembayaran. Silakan coba lagi.",
            "error"
          );
        }
      }

      function goBack() {
        window.electronAPI.navigateTo("cart.html");
      }

      function showNotification(message, type = "info") {
        const notification = document.getElementById("notification");
        const notificationText = document.getElementById("notification-text");

        notificationText.textContent = message;
        notification.className = `notification show ${type}`;

        // Auto hide after 3 seconds
        setTimeout(() => {
          notification.classList.remove("show");
        }, 3000);
      }

      // Close modals when clicking outside
      document.addEventListener("click", (e) => {
        if (e.target.classList.contains("modal")) {
          if (e.target.id === "success-modal") {
            // Don't allow closing success modal by clicking outside
            return;
          }
          e.target.style.display = "none";
        }

        // Handle navigation links
        if (
          e.target.matches('a[href="index.html"]') ||
          e.target.closest('a[href="index.html"]')
        ) {
          e.preventDefault();
          window.electronAPI.navigateTo("index.html");
        } else if (
          e.target.matches('a[href="cart.html"]') ||
          e.target.closest('a[href="cart.html"]')
        ) {
          e.preventDefault();
          window.electronAPI.navigateTo("cart.html");
        }
      });

      // Manual print with dialog function
      async function manualPrintReceipt() {
        try {
          console.log("üñ®Ô∏è Manual print dengan dialog...");

          // Get the last successful order data
          const orderId = document.getElementById("order-id").textContent;
          const finalAmount =
            document.getElementById("final-amount").textContent;

          if (!orderId || !cartItems || cartItems.length === 0) {
            showNotification("Data pesanan tidak ditemukan", "error");
            return;
          }

          const payload = {
            orderId: orderId,
            total: totalAmount,
            items: cartItems.map((item) => ({
              name: item.variant_name
                ? `${item.name} (${item.variant_name})`
                : item.name,
              quantity: item.quantity,
              price: item.price,
              details:
                Array.isArray(item.custom) || item.custom
                  ? buildDetailsForPrint(item)
                  : [],
            })),
            businessName: "JS Florist",
            address:
              "Jl. Dahlia No.23, Komet, Kec. Banjarbaru Selatan, Kota Banjar Baru",
            website: "www.jsflorist.com",
            whatsapp: "+62 823-5741-8002",
            instagram: "jsflorist.banjarbaru",
            servedByFlorist: (function () {
              try {
                return Number(localStorage.getItem("activeFlorist")) || null;
              } catch (_) {
                return null;
              }
            })(),
            notes: "Terima kasih atas kunjungan Anda",
            printMode: "dialog", // Force dialog mode
          };

          console.log("üñ®Ô∏è Manual print payload:", payload);

          // Call manual print with dialog
          const printRes = await window.electronAPI.printReceiptManual(payload);
          console.log("üñ®Ô∏è Manual print result:", printRes);

          if (printRes && printRes.success) {
            showNotification("‚úÖ Struk berhasil dicetak", "success");
          } else {
            showNotification(
              "‚ö†Ô∏è Print gagal: " + (printRes?.message || "Unknown error"),
              "error"
            );
          }
        } catch (error) {
          console.error("Manual print error:", error);
          showNotification("‚ùå Error saat print manual", "error");
        }
      }

      // Event listeners
      document.addEventListener("DOMContentLoaded", () => {
        // Existing listeners
        const newOrderBtn = document.getElementById("new-order-btn");
        if (newOrderBtn) {
          newOrderBtn.addEventListener("click", () => {
            window.electronAPI.navigateTo("index.html");
          });
        }

        // Manual print button
        const manualPrintBtn = document.getElementById("manual-print-btn");
        if (manualPrintBtn) {
          manualPrintBtn.addEventListener("click", manualPrintReceipt);
        }

        // Example silent print trigger
        const btnPrintReceipt = document.getElementById("btnPrintReceipt");
        if (btnPrintReceipt && window.printerAPI) {
          btnPrintReceipt.addEventListener("click", async () => {
            const transactionData = {
              title: "TOKO MAJU JAYA",
              items: [
                { name: "Susu Kotak", qty: 2, price: 5000 },
                { name: "Roti Tawar", qty: 1, price: 7500 },
                { name: "Permen", qty: 5, price: 1000 },
              ],
              total: 22500,
            };
            const selectedPrinter = "POS58 Printer"; // Ubah sesuai nama printer Anda
            try {
              const res = await window.printerAPI.printReceipt(
                transactionData,
                selectedPrinter
              );
              alert(`Struk terkirim ke printer ${selectedPrinter}`);
              console.log("Silent print result:", res);
            } catch (e) {
              alert(`Gagal mencetak struk: ${e.message}`);
              console.error(e);
            }
          });
        }

        // Toggle delivery inputs by type
        const addressGroup = document.getElementById("address-group");
        const datetimeGroup = document.getElementById("datetime-group");
        const deliveryRadios = document.querySelectorAll(
          'input[name="delivery-type"]'
        );
        const applyDeliveryType = () => {
          const type =
            (
              document.querySelector('input[name="delivery-type"]:checked') ||
              {}
            ).value || "delivery";
          const addressEl = document.getElementById("delivery-address");
          const dtEl = document.getElementById("delivery-datetime");
          const isPickup = type === "pickup";
          if (addressGroup) addressGroup.style.display = isPickup ? "none" : "";
          if (datetimeGroup)
            datetimeGroup.style.display = isPickup ? "none" : "";
          if (addressEl) addressEl.disabled = isPickup;
          if (dtEl) dtEl.disabled = isPickup;
        };
        deliveryRadios.forEach((r) =>
          r.addEventListener("change", applyDeliveryType)
        );
        applyDeliveryType();
      });
    </script>
  </body>
</html>
